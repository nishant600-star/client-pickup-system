{% extends "base.html" %}
{% block content %}

<h2 class="page-title">Pickup Entry</h2>

<div id="msgBox" class="mb-3"></div>

<!-- ===== ADD PICKUP ===== -->
<div class="card-modern mb-4">

    <h5 class="mb-3">Add Pickup</h5>

    <div class="row g-3">

        <div class="col-md-3">
            <select id="clientSelect" class="form-control"></select>
        </div>

        <div class="col-md-3">
            <input type="date" id="pickupDate" class="form-control">
        </div>

        <div class="col-md-2">
            <input type="number" id="pickupCount" class="form-control" placeholder="Count">
        </div>

        <div class="col-md-2">
            <button class="btn-modern w-100" onclick="addPickup()">
                Save
            </button>
        </div>

    </div>
</div>


<!-- ===== FILTERS ===== -->
<div class="card-modern mb-4">

    <h5 class="mb-3">Filter</h5>

    <div class="row g-3">

        <div class="col-md-3">
            <input type="date" id="filterDate" class="form-control">
        </div>

        <div class="col-md-3">
            <input type="text" id="filterClient" class="form-control" placeholder="Client name or code">
        </div>

        <div class="col-md-2">
            <button class="btn-modern w-100" onclick="loadPickups()">
                Apply
            </button>
        </div>

    </div>
</div>


<!-- ===== TABLE ===== -->
<div class="card-modern">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Pickup Records</h5>

        <a href="/export-pickups" class="btn-modern">
            Export Excel
        </a>
    </div>

    <table class="table table-borderless align-middle">
        <thead>
            <tr>
                <th>Date</th>
                <th>Client Code</th>
                <th>Client Name</th>
                <th>Count</th>
                <th>Action</th>
            </tr>
        </thead>

        <tbody id="pickupTable"></tbody>
    </table>

</div>


<script>

    // LOAD CLIENTS
    function loadClients() {
        fetch("/clients")
            .then(res => res.json())
            .then(data => {

                let options = "<option value=''>Select Client</option>";

                data.forEach(c => {
                    options += `<option value="${c.id}">
                        ${c.client_id} - ${c.name}
                    </option>`;
                });

                document.getElementById("clientSelect").innerHTML = options;
            });
    }


    // ADD PICKUP
    function addPickup() {

        const clientId = document.getElementById("clientSelect").value;
        const date = document.getElementById("pickupDate").value;
        const count = document.getElementById("pickupCount").value;

        if (!clientId || !date || !count) {
            document.getElementById("msgBox").innerHTML =
                `<div class="alert alert-danger">All fields required</div>`;
            return;
        }

        fetch(`/pickups?client_id=${clientId}&pickup_date=${date}&pickup_count=${count}`, {
            method: "POST"
        })
            .then(() => {

                document.getElementById("msgBox").innerHTML =
                    `<div class="alert alert-success">Pickup Saved ✔</div>`;

                loadPickups();
                document.getElementById("pickupCount").value = "";
            });
    }


    // LOAD PICKUPS
    function loadPickups() {

        const d = document.getElementById("filterDate").value;
        const c = document.getElementById("filterClient").value;

        let url = "/pickups";

        if (d || c) {
            url += "?";
            if (d) url += `pickup_date=${d}&`;
            if (c) url += `client=${c}`;
        }

        fetch(url)
            .then(res => res.json())
            .then(data => {

                let rows = "";

                if (data.length === 0) {
                    rows = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            No pickup records found
                        </td>
                    </tr>`;
                } else {

                    data.forEach(p => {
                        rows += `
                        <tr>
                            <td>${p.date}</td>
                            <td>${p.client_id}</td>
                            <td>${p.client_name}</td>
                            <td>${p.pickup_count}</td>
                            <td>

                                <button class="btn btn-sm btn-warning"
                                    onclick="editPickup(${p.id}, ${p.pickup_count})">
                                    Edit
                                </button>

                                <button class="btn btn-sm btn-danger"
                                    onclick="deletePickup(${p.id})">
                                    Delete
                                </button>

                            </td>
                        </tr>`;
                    });

                }

                document.getElementById("pickupTable").innerHTML = rows;
            });
    }


    // DELETE
    function deletePickup(id) {

        if (!confirm("Delete this pickup?")) return;

        fetch(`/pickups/${id}`, { method: "DELETE" })
            .then(() => {
                document.getElementById("msgBox").innerHTML =
                    `<div class="alert alert-success">Pickup Deleted ✔</div>`;
                loadPickups();
            });
    }


    // EDIT
    function editPickup(id, oldCount) {

        const newCount = prompt("Enter new pickup count:", oldCount);

        if (!newCount) return;

        fetch(`/pickups/${id}?pickup_count=${newCount}`, {
            method: "PUT"
        })
            .then(() => {
                document.getElementById("msgBox").innerHTML =
                    `<div class="alert alert-success">Pickup Updated ✔</div>`;
                loadPickups();
            });
    }


    loadClients();
    loadPickups();

</script>

{% endblock %}